<article class="gi-article-content gi-col-95 gi-row-90">
    <section class="gi-col-100 gi-row-100">
        <header class="gi-flex gi-flex-center gi-col-10">
            <h1 class="gi-page-title">메일관리 목록</h1>
        </header>
        <article class=" gi-col-90 gi-row-100">
            <!--      검색기능 영역      -->
            <div id="search-area" class="gi-col-35px gi-padding-left-right-20px gi-flex">
                <div class="gi-row-100 gi-flex gi-flex-space-around">
                    <!--      검색설정 영역      -->
                    <input class="gi-input gi-hidden"  data-required="false" type="text" id="lane_count" name="lane_count" data-focus-input-text-align="center" autocomplete="off" value=""/>
                    <input class="gi-input gi-hidden"  data-required="false" type="text" id="comprehensive_inspection_yn" name="comprehensive_inspection_yn" data-focus-input-text-align="center" autocomplete="off" value=""/>
                    <div class="gi-row-20 ">
                        <div class="gi-input-container gi-input-container-box-shadow gi-flex gi-col-100 " data-focus-line="false">
                            <label for="cont1" class="gi-input-label" data-focus-label="false" data-focus-label-text-align="center" data-required="false" >제목</label>
                            <input class="gi-input" data-required="false" type="text" id="cont1" name="cont1" data-focus-input-text-align="center" autocomplete="off"/>
                        </div>
                    </div>
                    <div class="gi-row-25 gi-flex">
                        <div class="gi-input-container gi-col-100 gi-input-container-box-shadow gi-flex " data-focus-line="false">
                            <label for="from_date" class="gi-input-label" data-focus-label="false" data-focus-label-text-align="center" data-required="false">작성 시작일</label>
                            <input id="from_date" class="gi-input " data-required="false" type="text" name="from_date" autocomplete="off" data-focus-input-text-align="center" gi-datepicker/>
                        </div>
                        <div class="gi-flex gi-flex-align-items-center">
                            <span class="gi-date-middle-symbol"> ~ </span>
                        </div>
                        <div class="gi-input-container gi-col-100 gi-input-container-box-shadow gi-flex " data-focus-line="false">
                            <label for="to_date" class="gi-input-label" data-focus-label="false" data-focus-label-text-align="center" data-required="false">작성 종료일</label>
                            <input id="to_date" class="gi-input " data-required="false" type="text" name="to_date" autocomplete="off" data-focus-input-text-align="center" gi-datepicker/>
                        </div>
                    </div>
                    <!--/     검색설정 영역      -->
                    <!--/     날짜선택 영역      -->

                    <!--      더보기,초기화 버튼 영역      -->
                    <div class="gi-row-10 gi-col-100 gi-flex gi-flex-align-items-center ">
                        <div class="gi-btn-section gi-col-100 gi-flex gi-flex-justify-content-space-evenly">
                            <!--                            <button id="more-btn" class="gi-btn-more  gi-input-container-box-shadow" type="button"><i class="fa-solid fa-gear gi-row-30px"></i>더보기</button>-->
                            <button id="reset-btn" class="gi-btn-reset  gi-input-container-box-shadow" type="button"><i class="fa-solid fa-rotate-right gi-row-30px"></i>초기화</button>
                        </div>
                    </div>
                    <!--/     더보기,초기화 버튼 영역      -->
                    <!--     조회 버튼 영역      -->
                    <div class="  gi-col-100 gi-flex  gi-flex-justify-content-flex-end gi-margin-left-1">
                        <div class="gi-btn-section gi-row-40 gi-col-100 gi-flex  gi-flex-justify-content-flex-end"></div>
                    </div>
                    <div class=" gi-col-100 gi-row-40 gi-flex  gi-flex-justify-content-flex-end gi-margin-left-1">
                        <div class="gi-btn-section gi-row-40 gi-col-100 gi-flex  gi-flex-justify-content-flex-end">
                            <button id="search-btn" class="gi-btn-search gi-row-40px gi-input-container-box-shadow" type="button">조회</button>
                        </div>
                    </div>
                </div>
            </div>
            <!--/     검색기능 영역      -->
            <div class="gi-row-100 gi-col-90">
                <div id="gi-Grid"></div>
                <div class="gi-row-100">
                    <button id="register-btn" class="gi-btn gi-float-right gi-col-30px" type="button">등록</button>
                </div>
            </div>
            <!--                <div id="gi-Grid" class="gi-Grid" data-side-grid-open="true" data-side-grid-open-init="true"></div>-->
            <!--                <div class="gi-Grid-side" id="gi-Grid-side" data-side-grid-open="false"></div>-->
            </div>
            <!--      등록버튼 영역      -->
<!--            <div class="gi-row-100">-->
<!--                <div class="gi-btn-section gi-row-30 gi-float-right gi-padding-left-right-20px">-->
<!--                    <button id="insert-btn" class="gi-btn gi-float-right " type="button">등록</button>-->
<!--                </div>-->
<!--            </div>-->
            <!--/     추가버튼 영역      -->
        </article>
    </section>
</article>
<script type="text/javascript">
    var PRGMID = "siteScheduledMailList";	//page id
    init();
    function init(){


        //초기화
        resetEvent();

        //데이터 조회
        findBySiteScheduledMailList();

        setTimeout(function(){
            //페이지 초기설정
            new PageInit();


            //클릭 이벤트
            clickEvent();
        });
    }

    function resetEvent(){
        //검색영역 값 초기화
        $("#search-area input").val("");
        $("#search-area select").val("");

        //데이터 호출 후 이벤트 재설정
        new afterLoadDataEvent();
    }

    //클릭 이벤트
    function clickEvent(){
        // 초기화버튼 클릭 이벤트
        $(".gi-btn-reset").click(function(){
            resetEvent();
            findBySiteScheduledMailList();
        });
        //조회버튼 클릭 이벤트
        $("#search-btn").click(function(){
            findBySiteScheduledMailList();
        });

        //추가버튼 클릭 이벤트
        $("#register-btn").click(function(){
            redirectRegisterPage()
        });
    }
    async function findBySiteScheduledMailList(page,range,sortId,sortOrder) {
        //default page
        if(!formUtil.checkEmptyValue(page)) page = 1;
        //default range(row)
        if(!formUtil.checkEmptyValue(range)) range = 10;

        let url = "/common/site/siteScheduledMail/findPage";
        let param = {
            page_no:page,
            row_range : range
        };
        // 검색조건 설정 (추가해서 사용)
        let cont1 = $("#searchDesc1").val();
        let cont2 = $("#from_date").val();
        let cont3 = $("#to_date").val();
        if(formUtil.checkEmptyValue(cont1)) param.searchDesc1 = cont1;
        if(formUtil.checkEmptyValue(cont2)) param.from_date = cont2;
        if(formUtil.checkEmptyValue(cont3)) param.to_date   = cont3;

        // 정렬조건추가 (기준id, 순서)
        if(formUtil.checkEmptyValue(sortId)) param.sort_id = sortId;
        if(formUtil.checkEmptyValue(sortOrder)) param.sort_order = sortOrder;

        await axios.post(url, param).then(response => {
            let status = response.status;
            if (status === 200) {
                let data = response.data.DATA;
                let paging = response.data.TOTAL_PAGING[0];

                // 그리드 헤더 설정
                let siteScheduledMail_menuGrid_header = {
                    title : "메일관리 목록",
                    list:[
                        {HEADER:"No",  ID:"no",   WIDTH:"5",TYPE:"text",FONT_SIZE:"12px",TEXT_ALIGN:"center",HIDDEN:false},
                        {HEADER:"메일제목",  ID:"title",  WIDTH:"25",TYPE:"text",FONT_SIZE:"12px",TEXT_ALIGN:"center",HIDDEN:false},
                        {HEADER:"발송대상",  ID:"target_group",  WIDTH:"20",TYPE:"text",FONT_SIZE:"12px",TEXT_ALIGN:"center",HIDDEN:false},
                        {HEADER:"예약여부",  ID:"scheduled_yn_name",  WIDTH:"10",TYPE:"text",FONT_SIZE:"12px",TEXT_ALIGN:"center",HIDDEN:false},
                        {HEADER:"예약일자",  ID:"scheduled_ymd",  WIDTH:"15",TYPE:"text",FONT_SIZE:"12px",TEXT_ALIGN:"center",HIDDEN:false},
                        {HEADER:"예약시간",  ID:"scheduled_time",  WIDTH:"5",TYPE:"text",FONT_SIZE:"12px",TEXT_ALIGN:"center",HIDDEN:false},
                        {HEADER:"상태코드",  ID:"state_code_name",  WIDTH:"10",TYPE:"text",FONT_SIZE:"12px",TEXT_ALIGN:"center",HIDDEN:false},
                        {HEADER:"작성일자",  ID:"system_create_date",  WIDTH:"10",TYPE:"text",FONT_SIZE:"12px",TEXT_ALIGN:"center",HIDDEN:false},
                        {HEADER:"재발송",  ID:"resend_btn",  WIDTH:"5",TYPE:"button",FONT_SIZE:"12px",TEXT_ALIGN:"center",HIDDEN:false},
                        {HEADER:"상세",  ID:"detail_btn",  WIDTH:"5",TYPE:"button",FONT_SIZE:"12px",TEXT_ALIGN:"center",HIDDEN:false},

                        {HEADER:"상태코드",  ID:"state_code",  WIDTH:"10",TYPE:"text",FONT_SIZE:"12px",TEXT_ALIGN:"center",HIDDEN:true},
                        {HEADER:"예약여부",  ID:"scheduled_yn",  WIDTH:"10",TYPE:"text",FONT_SIZE:"12px",TEXT_ALIGN:"center",HIDDEN:true},
                        {HEADER:"메일ID(SEQ)",  ID:"mail_id",  WIDTH:"40",TYPE:"text",FONT_SIZE:"12px",TEXT_ALIGN:"center",HIDDEN:true},
                        {HEADER:"메일내용",  ID:"content",  WIDTH:"40",TYPE:"text",FONT_SIZE:"12px",TEXT_ALIGN:"center",HIDDEN:true},
                        {HEADER:"실패사유코드",  ID:"failure_reason_code",  WIDTH:"40",TYPE:"text",FONT_SIZE:"12px",TEXT_ALIGN:"center",HIDDEN:true},
                        {HEADER:"작성자ID",  ID:"system_create_userid",  WIDTH:"40",TYPE:"text",FONT_SIZE:"12px",TEXT_ALIGN:"center",HIDDEN:true},
                        {HEADER:"수정자ID",  ID:"system_update_userid",  WIDTH:"40",TYPE:"text",FONT_SIZE:"12px",TEXT_ALIGN:"center",HIDDEN:true},
                        {HEADER:"수정일자",  ID:"system_update_date",  WIDTH:"40",TYPE:"text",FONT_SIZE:"12px",TEXT_ALIGN:"center",HIDDEN:true}
                    <!--{HEADER:"사이드 그리드",  ID:"sideGridOpen_btn",  WIDTH:"15",TYPE:"button",FONT_SIZE:"12px",TEXT_ALIGN:"center",HIDDEN:false}-->
                    <!--{HEADER:"checkbox",  ID:"checkbox",  WIDTH:"25",TYPE:"checkbox",FONT_SIZE:"12px",TEXT_ALIGN:"center",HIDDEN:false},-->
                    ]
                }
                //그리드 생성 <div id="gi-Grid"></div>
                let siteScheduledMail_menu_grid = formUtil.giGrid(siteScheduledMail_menuGrid_header,paging,page);

                //그리드 하이라키 구조로 변경
                //let siteScheduledMail_menu_grid = formUtil.giGridHierarchy(siteScheduledMail_menuGrid_header,paging,page);
                //siteScheduledMail_menu_grid.HierarchyOption({level_column:"",parent_depth_column:"",child_depth_column:""});

                //사이드 그리드 설정
                //siteScheduledMail_menu_grid.sideOpenBtnClick("gi-Grid-side","sideGridOpen_btn");

                //그리드 데이터 설정
                siteScheduledMail_menu_grid.DataSet(data);

                //그리드 row 개수 변경 및 페이징 버튼 이벤트 설정
                siteScheduledMail_menu_grid.pagingSet(findBySiteScheduledMailList);

                //그리드 내부의 상세 버튼 클릭 이벤트 설정(버튼클릭시 호출될 함수, 그리드 헤더 부분에 설정한 버튼 ID)
                siteScheduledMail_menu_grid.detailBtnClick(redirectDetailPage,"detail_btn");

                siteScheduledMail_menu_grid.resendBtnClick(resendMail,"resend_btn");

                //그리스 내부의 header click 정렬 이벤트 설정
                siteScheduledMail_menu_grid.sortDataSet(findBySiteScheduledMailList);

                hideSpecificData()
                //발송실패 외에 재발송 비활성화
                function hideSpecificData() {
                    let btnIndex;
                    let stateIndex;

                    $('#gi-grid-list-body').find('ul').each(function(i, ulRow) {
                        if (i === 0) {
                            $(ulRow).find('li').each(function(index, liRow) {
                                if ($(liRow).data('column') === 'resend_btn' && typeof btnIndex === 'undefined') {
                                    btnIndex = index;
                                }
                                if ($(liRow).data('column') === 'state_code' && typeof stateIndex === 'undefined') {
                                    stateIndex = index;
                                }
                            });
                        } else {
                            let stateLi;
                            let btnLi;
                            $(ulRow).find('li').each(function(index, liRow) {
                                if ($(liRow).data('grid-row') === stateIndex) {
                                    stateLi = $(liRow);
                                }

                                if ($(liRow).data('grid-row') === btnIndex) {
                                    btnLi = $(liRow);
                                }
                            });
                            if (stateLi && btnLi) {
                                if (stateLi.children('span').text() !== '0') {
                                    btnLi.children('button').addClass('gi-hidden');
                                }
                            }
                        }
                    });
                }


            } else {
                formUtil.alertPopup("response status is :" + status);
            }
        }).catch(error => {
            formUtil.alertPopup(error);
        })
    }

    function resendMail(result) {
        console.log(result)

        let url = "/common/site/siteScheduledMail/resend";
        let param = {
            mail_id : result.mail_id,
            title : result.title,
            content : result.content,
        };
        axios.post(url,param).then(response =>{
            let status = response.status;
            if (status === 200) {
                formUtil.showMessage(Message.Label.Array["COMPLETE.RESEND"]);
            } else {
                resetEvent();
                formUtil.alertPopup("response status is :" + status);
            }
        }).catch(error => {
            resetEvent();
            formUtil.alertPopup(error);
        })
    }

    function redirectDetailPage(redirectDataList){
        let url = "/common/site/siteScheduledMailDetail";

        //이전페이지 아이디 설정
        redirectDataList["pre_page_id"] =  "/common/site/siteScheduledMailList";
        // console.log(redirectDataList)

        formUtil.loadContent(url , redirectDataList);
    }
    function redirectRegisterPage(){
        let url = "/common/site/siteScheduledMailRegister";
        formUtil.loadContent(url);
    }


</script>