<style>
    .user_icon_layout_body {
        position: relative;
    }

    .add_user_img-btn {
        padding: var(--padding-btn);
        height: 100%;
        min-width: 30px;
        border: none;
        background-color: #ffffff;
        color: #000000;
        border-radius: 50%;
        cursor: pointer;
        transition: 0.2s ease-in-out;
        margin: 0 5px 0 5px;
        background-image: url(/common/img/add.svg);
        background-repeat: no-repeat;
        background-size: contain;
    }

    .add_user_img-btn:hover {
        background-image: url(/common/img/add-hover.svg);
    }

    .add_user_img-btn-section {
        position: absolute;
        height: 30px;
        top: 90%;
        left: 90%;
    }
</style>
<article class="gi-article-content gi-col-95 gi-row-90">
    <section class="gi-col-100 gi-row-100">
        <header class="gi-flex gi-flex-center gi-col-10">
            <h1 class="gi-page-title">내 정보 수정</h1>
        </header>
        <article class="gi-col-90 gi-row-100 gi-grid gi-grid-template-rows-9fr-1fr gi-grid-gap-10px-10px">
            <!--      업데이트 영역      -->
            <form id="inspectionEquipmentModelTypeModify" class="gi-row-100 gi-col-100 gi-overflow">
                <div class="gi-row-100 gi-padding-5px gi-grid-container gi-grid gi-grid-justify-items-center gi-grid-gap-10px gi-margin-bottom-15px">
                    <div class="gi-flex gi-flex-direction-column gi-flex-center gi-flex-justify-content-space-around gi-margin-bottom-20px">
                        <div class="user_icon_layout_body">
                            <div class="user_icon_layout">
                                <div class="userIcon"></div>
                            </div>
                            <div class="add_user_img-btn-section">
                                <button id="imgFileUpload" class="add_user_img-btn" type="button"></button>
                            </div>
                        </div>
                    </div>

                    <div class="gi-row-60 gi-col-100 gi-grid gi-grid-template-columns-repeat-1-1fr-2fr gi-grid-rows-container">
                        <div class="gi-row-100 gi-col-100 gi-flex gi-flex-center gi-layout-detail-title gi-grid-input-edge-left-top">
                            <span>내 정보</span>
                        </div>
                        <div class="gi-row-100 gi-col-100 gi-grid gi-grid-template-columns-repeat-1-1fr-1fr">
                            <input data-field="id" id="id" name="id" class="gi-input gi-hidden"/>
                            <input data-field="uuid" id="uuid" name="uuid" class="gi-input gi-hidden"/>

                            <div class="gi-row-100 gi-input-container gi-input-container-box-border gi-flex gi-flex-center">
                                <label for="user_name" class="gi-input-label" data-focus-label="true" data-focus-label-text-align="default" data-required="true">이름</label>
                                <input data-field="user_name" id="user_name" name="user_name" class="gi-input" data-focus-span-text-align="default" data-required="true" autocomplete="off" gi-maxlength="100"/>
                            </div>
                            <div class="gi-row-100 gi-input-container gi-input-container-box-border gi-flex gi-flex-center gi-grid-input-edge-right-top">
                                <label for="tel" class="gi-input-label" data-focus-label="true" data-focus-label-text-align="default">TEL</label>
                                <input data-field="tel" id="tel" name="tel" class="gi-input" data-focus-span-text-align="default" autocomplete="off" gi-format-check="phone_number"/>
                            </div>
                            <div class="gi-row-100 gi-input-container gi-input-container-box-border gi-flex gi-flex-center">
                                <label for="email" class="gi-input-label" data-focus-label="true" data-focus-label-text-align="default" data-required="true">email</label>
                                <input data-field="email" id="email" name="email" class="gi-input" data-focus-span-text-align="default" data-required="true" autocomplete="off" data-gi-tag-disabled/>
                            </div>
                            <div class="gi-row-100 gi-input-container gi-input-container-box-border gi-flex gi-flex-center">
                                <label for="user_id" class="gi-input-label" data-focus-label="true" data-focus-label-text-align="default" data-required="true">id</label>
                                <input data-field="user_id" id="user_id" name="user_id" class="gi-input" data-focus-span-text-align="default" data-required="true" autocomplete="off" data-gi-tag-disabled/>
                            </div>
                            <div class="gi-row-100 gi-col-100">
                                <div class="gi-row-100 gi-input-container gi-input-container-box-border gi-flex gi-flex-center">
                                    <label for="address" class="gi-input-label" data-focus-label="true" data-focus-label-text-align="default">사용본거지주소</label>
                                    <input data-field="address" id="address" name="address" class="gi-input" data-focus-span-text-align="default" autocomplete="off" data-gi-tag-disabled/>
                                </div>
                            </div>
                            <div class="gi-row-100 gi-col-100">
                                <div class=" gi-col-100 gi-grid gi-grid-template-columns-repeat-1-1fr-2fr">
                                    <div class="gi-grid gi-input-container gi-input-container-box-border gi-flex gi-flex-center">
                                        <button id="address-btn" class="gi-input-btn" type="button" gi-address>검색</button>
                                    </div>
                                    <div class="gi-row-100 gi-input-container gi-input-container-box-border gi-flex gi-flex-center">
                                        <label for="address_detail" class="gi-input-label" data-focus-label="true" data-focus-label-text-align="default">사용본거지상세주소</label>
                                        <input data-field="address_detail" id="address_detail" name="address_detail" class="gi-input" data-focus-span-text-align="default" autocomplete="off" gi-maxlength="100"/>
                                    </div>
                                </div>
                            </div>
                            <div class="gi-row-100 gi-col-100 gi-hidden">
                                <div class="gi-row-100 gi-input-container gi-input-container-box-border gi-flex gi-flex-center">
                                    <label for="postal_code" class="gi-input-label" data-focus-label="true" data-focus-label-text-align="default">우편번호</label>
                                    <input data-field="postal_code" id="postal_code" name="postal_code" class="gi-input" data-focus-span-text-align="default" autocomplete="off"/>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="gi-row-60 gi-col-100 gi-grid gi-grid-template-columns-repeat-1-1fr-2fr gi-grid-rows-container">
                        <div class="gi-row-100 gi-col-100 gi-flex gi-flex-center gi-layout-detail-title">
                            <span>권한</span>
                        </div>
                        <div class="gi-row-100 gi-col-100 ">
                            <div id="user-group-div" class="gi-row-100 gi-input-container gi-input-container-box-border gi-flex gi-col-100 gi-flex-wrap">
                            </div>
                        </div>
                    </div>

                    <div class="gi-row-60 gi-col-100 gi-grid gi-grid-template-columns-repeat-1-1fr-2fr gi-grid-rows-container">
                        <div class="gi-row-100 gi-col-100 gi-flex gi-flex-center gi-layout-detail-title">
                            <span>소속</span>
                        </div>
                        <div class="gi-row-100 gi-col-100 gi-grid gi-grid-template-columns-2fr-2fr">
                            <div class="gi-row-100 gi-input-container gi-input-container-box-border gi-flex gi-flex-center">
                                <label for="office_name" class="gi-input-label" data-focus-label="true" data-focus-label-text-align="default">소속</label>
                                <input data-field="office_name" id="office_name" name="office_name" class="gi-input" data-focus-span-text-align="default" autocomplete="off" data-gi-tag-disabled/>
                            </div>
                            <div class="gi-row-100 gi-input-container gi-input-container-box-border gi-flex gi-flex-center">
                                <label for="office_code" class="gi-input-label" data-focus-label="true" data-focus-label-text-align="default">소속코드</label>
                                <input data-field="office_code" id="office_code" name="office_code" class="gi-input" data-focus-span-text-align="default" autocomplete="off" data-gi-tag-disabled/>
                            </div>
                        </div>
                    </div>

                    <div class="gi-row-60 gi-col-100 gi-grid gi-grid-template-columns-repeat-1-1fr-2fr gi-grid-rows-container">
                        <div class="gi-row-100 gi-col-100 gi-flex gi-flex-center gi-layout-detail-title gi-grid-input-edge-left-bottom">
                            <span>수정일</span>
                        </div>
                        <div class="gi-row-100 gi-col-100 gi-grid gi-grid-template-columns-2fr-2fr">
                            <div class="gi-row-100 gi-input-container gi-input-container-box-border gi-flex gi-flex-center">
                                <label for="system_create_date" class="gi-input-label" data-focus-label="true" data-focus-label-text-align="default">등록일</label>
                                <input data-field="system_create_date" id="system_create_date" name="system_create_date" class="gi-input" data-focus-span-text-align="default" autocomplete="off" data-gi-tag-disabled/>
                            </div>
                            <div class="gi-row-100 gi-input-container gi-input-container-box-border gi-flex gi-flex-center gi-grid-input-edge-right-bottom">
                                <label for="system_update_date" class="gi-input-label" data-focus-label="true" data-focus-label-text-align="default">마지막 수정일</label>
                                <input data-field="system_update_date" id="system_update_date" name="system_update_date" class="gi-input" data-focus-span-text-align="default" autocomplete="off" data-gi-tag-disabled/>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <!--/     업데이트 영역      -->
            <!--      버튼 영역      -->
            <div class="gi-row-100 gi-col-100 gi-flex gi-flex-justify-content-center gi-flex-align-items-center gi-overflow-scroll">
                <div class="gi-btn-section gi-row-30 gi-col-30px gi-padding-left-right-20px gi-flex gi-flex-justify-content-center gi-flex-align-items-center">
                    <button id="change-password-btn" class="gi-btn-blue" type="button">비밀번호 변경</button>
                    <button id="modify-btn" class="gi-btn-blue" type="button">저장</button>
                </div>
            </div>
            <!--/     버튼 영역      -->
        </article>
    </section>
</article>

<script type="text/javascript">
    var PRGMID = "inspectionEquipmentModelTypeModify";	//page id
    var newSession = new session(); // HACK var..
    var newDataBinding = new dataBinding(); // HACK var..
    init();


    function init() {
        //초기화
        resetEvent();

        setTimeout(function () {
            //페이지 초기설정
            new PageInit();

            dataSetting();

            //클릭 이벤트
            clickEvent();
        });
    }

    async function dataSetting() {
        const userInfo = await findUserData();

        let data_binding = new dataBinding();
        data_binding.setDataForm(PRGMID, userInfo.user);

        bindUserGroup(userInfo.userGroups);
        findImgFile();

        let data = data_binding.getData(PRGMID);

        //초기 값 셋팅
        initValueSetting(data);

        function bindUserGroup(userGroups) {
            let userGroupHtml = '';
            userGroups.forEach((group) => {
                userGroupHtml += "<span class='gi-tag-gray gi-col-24px'>" + group.group_name + "</span>";
            });

            $("#user-group-div").html(userGroupHtml);
        }
    }

    async function findUserData() {
        try {
            const email = JwtUtils.getUserEmailFromJWT();

            const [userResponse, userGroupsResponse] = await Promise.all([
                axios.post('/common/common/commonUser/find', {email}),
                axios.post('/common/common/commonUserGroup/find', {user_email: email})
            ]);

            return {
                user: userResponse.data[0],
                userGroups: userGroupsResponse.data
            };
        } catch (error) {
            formUtil.alertPopup(error);
            throw error;
        }
    }

    function resetEvent() {
        //데이터 호출 후 이벤트 재설정
        new afterLoadDataEvent();
    }

    //클릭 이벤트
    function clickEvent() {
        // 초기화 버튼 클릭 이벤트
        $(".gi-btn-reset").click(function () {

        });
        //수정 버튼 클릭 이벤트
        $("#modify-btn").click(function () {
            modify();
        });

        $("#change-password-btn").click(function () {
            changePassword();
        });
    }

    function initValueSetting(data) {
        formUtil.createImgFileUpload("imgFileUpload", "/common/file/commonFileDetail", {FOLDER_NAME: "userImgFolder"}, modifyUserImage);
    }

    async function modify() {
        if (!checkValidation()) return false;
        if (!await formUtil.confirm(Message.Label.Array["CONFIRM.UPDATE"])) return false;

        let data = new dataBinding().getData(PRGMID);
        let url = "/common/common/commonUser/update";
        let param = {
            id: data.id,
            user_name: data.user_name,
            tel: data.tel,
            address: data.address,
            address_detail: data.address_detail,
            postal_code: data.postal_code,
        };
        axios.post(url, param).then(response => {
            let status = response.status;
            if (status === 200) {
                (new GiFormatCheck).resetToggleIcon();
                formUtil.showMessage(Message.Label.Array["COMPLETE.UPDATE"]);
            } else {
                formUtil.alertPopup("response status is :" + status);
            }
        }).catch(error => {
            formUtil.alertPopup(error);
        })
    }

    async function changePassword() {
        const popupHtml = `
                <div id="change-password-popup" class="prompt">
                    <div class="popup_content" style="width: 340px; height: 400px;">
                        <div class="popup_text">
                            <span>비밀번호 변경</span>
                        </div>
                        <div class="gi-row-100 gi-col-50" style="display: flex; flex-direction: column;">
                            <div class="gi-row-100 gi-flex gi-input-container-box-border" style="border-bottom: none; border-radius: var(--border-grid-input-edge) var(--border-grid-input-edge) 0 0;">
                                <div class="gi-row-100 gi-input-container gi-flex gi-flex-center">
                                    <label for="popup_before_password" class="gi-input-label" data-focus-label="true" data-focus-label-text-align="default" data-required="true">기존 비밀번호</label>
                                    <input type="password" data-field="popup_before_password" id="popup_before_password" name="popup_before_password" class="gi-input" data-focus-span-text-align="default" data-required="true" autocomplete="off"/>
                                </div>
                            </div>
                            <div class="gi-row-100 gi-flex gi-input-container-box-border" style="border-bottom: none;">
                                <div class="gi-row-100 gi-input-container gi-flex gi-flex-center">
                                    <label for="popup_new_password1" class="gi-input-label" data-focus-label="true" data-focus-label-text-align="default" data-required="true">새 비밀번호</label>
                                    <input type="password" data-field="popup_new_password1" id="popup_new_password1" name="popup_new_password1" class="gi-input" data-focus-span-text-align="default" data-required="true" autocomplete="off"/>
                                </div>
                            </div>
                            <div  class="gi-row-100 gi-flex gi-input-container-box-border" style=" border-radius: 0 0 var(--border-grid-input-edge) var(--border-grid-input-edge);">
                                <div class="gi-row-100 gi-input-container gi-flex gi-flex-center">
                                    <label for="popup_new_password2" class="gi-input-label" data-focus-label="true" data-focus-label-text-align="default" data-required="true">새 비밀번호 확인</label>
                                    <input type="password" data-field="popup_new_password2" id="popup_new_password2" name="popup_new_password2" class="gi-input" data-focus-span-text-align="default" data-required="true" autocomplete="off"/>
                                </div>
                            </div>

                        </div>
                        <div class="gi-btn-section gi-row-30 gi-col-40px gi-padding-left-right-20px gi-flex gi-flex-justify-content-center gi-flex-align-items-center">
                            <button type="button" class="gi-btn-blue popup_success_btn">확인</button>
                            <button type="button" class="gi-btn popup_cancel_btn">취소</button>
                        </div>
                    </div>
                </div>
            `;

        $(".PopupBody").append(popupHtml);

        new PageInit();

        commonTag.inputTagFocus($("#popup_input"));

        $(`#change-password-popup .popup_success_btn`).click(async function () {
            const beforePassword = $(`#popup_before_password`).val();
            const newPassword = $(`#popup_new_password1`).val();
            const newPasswordConfirm = $(`#popup_new_password2`).val();

            if (!beforePassword || !newPassword || !newPasswordConfirm) {
                const message = Message.Label.Array["COMMON_USER.CHECK.PASSWORD"];
                formUtil.alertPopup(message);
                return false;
            }

            if (newPassword !== newPasswordConfirm) {
                const message = Message.Label.Array["COMMON_USER.CHECK.CHECK_PASSWORD"];
                formUtil.alertPopup(message);
                return false;
            }

            if (beforePassword === newPassword) {
                const message = Message.Label.Array["FAIL.SAME.PASSWORD"];
                formUtil.alertPopup(message);
                return false;
            }

            const url = "/common/common/commonUser/changePassword";
            const param = {
                before_password: beforePassword,
                password: newPassword,
                email: JwtUtils.getUserEmailFromJWT()
            };

            try {
                const response = await axios.post(url, param);
                if (response.status === 200) {
                    const message = Message.Label.Array["COMPLETE.UPDATE"]
                    formUtil.showMessage(message);
                    $(`#change-password-popup`).remove();
                }
            } catch (error) {
                const errorData = error.response?.data;

                if (errorData === 'NOT_MATCH_PASSWORD') {
                    formUtil.alertPopup(Message.Label.Array["FAIL.NOT.MATCHED.PASSWORD"]);
                    return false;

                }

                formUtil.alertPopup(errorData || error.message || error);
            }
        });

        $(`#change-password-popup .popup_cancel_btn`).click(function () {
            $(`#change-password-popup`).remove();
            return false;
        });
    }

    function modifyUserImage() {
        let flag = checkValidation();
        if (flag) {
            let data = new dataBinding().getData(PRGMID);
            let url = "/common/common/commonUser/update";
            let param = {
                id: data.id,
                uuid: data.uuid,
            };
            axios.post(url, param).then(response => {
                let status = response.status;
                if (status === 200) {
                    formUtil.showMessage(Message.Label.Array["COMPLETE.UPDATE"]);

                    findImgFile();
                } else {
                    formUtil.alertPopup("response status is :" + status);
                }
            }).catch(error => {
                formUtil.alertPopup(error);
            })
        }
    }

    function checkValidation() {
        let flag = false;

        let validation = [];
        validation.formId = PRGMID;
        $(".gi-input[data-required='true'],.gi-select[data-required='true']").map((i, item) => {
            if ($(item).data("field")) {
                let messageId = $(item).data("field").toUpperCase();
                let message = Message.Label.Array["COMMON_USER.CHECK." + messageId];
                validation.push({id: item.id, message: message});
            }
        });
        if (formUtil.validationCheck(validation)) {
            flag = true;
        }
        return flag;
    }

    function findImgFile() {
        let url = "/common/file/commonFileDetail/find";
        let param = {
            uuid: $('#uuid').val()
        }
        axios.post(url, param).then(response => {
            let status = response.status;
            if (status === 200) {
                if (formUtil.checkEmptyValue(response.data)) {
                    let data = response.data[0];
                    let filePath = data.file_path;
                    let fileId = data.file_id + "." + data.file_extension;
                    let cont = {
                        path: filePath,
                        file_id: fileId
                    }
                    findFileManagerGetImg(cont);
                }
            }
        }).catch(error => {
            formUtil.alertPopup(error + "");
        })
    }

    function findFileManagerGetImg(data) {
        let url = "/fileManager/searchImg";
        let param = {
            file_path: data.path + "/",
            file_id: data.file_id
        }
        axios.post(url, param).then(response => {
            let status = response.status;
            if (status === 200) {
                if (formUtil.checkEmptyValue(response.data)) {
                    let data = response.data;
                    $(".userIcon").css("background-image", "url('" + data + "')");

                    setImageSource(data);

                    $('#formUtil_fileUpload').empty(); // TODO
                }
            }
        }).catch(error => {
            formUtil.alertPopup(error + "");
        })
    }

    function setImageSource(url) {
        $('#user-image').attr('src', url);
    }
</script>